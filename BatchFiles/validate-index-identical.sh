# Given two solr LB, validates prints the numFound for a bunch of collections.
# Useful to validate that the index is identical between the two clusters.
# Running instructions: ./validate-index-indentical.sh

# set -o xtrace 
set -o errexit

PROD_LB="internal-qa-canary1-793981271.us-east-1.elb.amazonaws.com"
MOB1_LB="internal-qa-canary2-1800934364.us-east-1.elb.amazonaws.com"

MERCHANTS=("wrangler" "shutterfly" "beallsflorida" "bergdorfgoodman" "dwr" "fabric_com" "farfetch_au" "farfetch_ca" "farfetch_hk" "farfetch_nz" "farfetch_uk" "fossil" "frontgate" "gardeners" "garnethill" "grandinroad" "horchow" "hsn" "josbank" "lastcall" "lumens_com" "markandgraham" "menswearhouse" "mileskimball" "onekingslane" "pbteen" "saksfifthavenue" "thecontainerstore" "thenorthface" "wdrake" "stumpsparty" "qvc" "carrierenterprise" "carrierenterprise_fr" "oldnavy" "screwfix" "lee" "planetart_simplytoimpress" "shindigz" "jansport" "farfetch_us" "brighton_com" "annieselke" "allsaints_com" "officesupply_com" "athleta" "smartpak" "ironplanet" "papermart" "allsaints_global" "allsaints_global_es" "allsaints_global_it" "allsaints_global_fr" "allsaints_global_de" "shoes" "us_allsaints_com" "arrow" "hottopic" "potterybarn" "potterybarn_en_uat_d1" "potterybarn_en_prd_release_test" "jensonusa_com" "potterybarnkids" "bakerdist" "worldmarket_com" "oldnavy_ca" "oldnavy_ca_fr" "davidsbridal" "sportsmansguide_com" "samsclub" "gemaire" "solidsignal" "discountschoolsupply" "ecmdi" "ylighting" "1800flowers_com" "vans" "vans_fr" "gap" "signaturehardware" "lampsplus" "ascowholesale" "boxlunch" "williamssonoma" "dollartree" "bsnsports" "uncommongoods" "dollargeneral" "hallmark" "palmetto" "karwei_nl" "levis" "planetart_photoaffections" "vitaminshoppe" "hdsupplysolutions" "homeoasis_bloomreach" "torrid" "livingspaces_com" "bananarepublic" "paige" "potterybarnkids_qa_en_d1" "williamssonoma_en_ws_prd_d1" "pbteen_en_pt_uat_d1" "westelm_qa" "boden_global" "bananarepublic_ca" "quill" "home24" "potterybarn_en_en_uat2_d1" "forever21_eu_de" "westelm_en_we_prd_d1" "potterybarn_qa_en_d1" "westelm_en_we_prd_d3" "staples_ca_3day" "forever21_eu_fr" "poc_commercetools" "mattel_dev2" "mattel" "forever21_ca_com" "staples_ca_perf" "gap_co_uk" "potterybarnkids_en_pk_prd_release_test" "eway_ca" "potterybarnkids_en_pk_uat2_d1" "potterybarn_en_pb_prd_d3" "eway_ca_fr" "westelm_qa_en_d3" "markandgraham_qa" "interflora_co_uk_uat1" "williamssonoma_qa_en_d2" "next_uk_bronze" "pbteen_qa" "next" "pbteen_en_pt_prd_d2" "potterybarnkids_en_pk_prd_d1" "mattel_qa3" "westelm_en_prd_release_test" "hallmark" "forever21_eu_com" "albertsons" "williamssonoma_qa" "smartpak" "diy_com" "homedepot_ca" "williamssonoma_qa_en_d1" "potterybarn_qa_en_d3" "potterybarnkids_en_pk_prd_d3" "westelm_en_uat3_d1" "staples_ca" "searsoutlet_com" "westelm_en_we_prd_d2" "potterybarn_qa" "pbteen_en_pt_prd_d1" "westelm" "mattel_dev3" "westelm_qa_en_d1" "interflora_ie" "neimanmarcus" "gap_eu" "potterybarn" "barnesandnoble" "staples_ca_qa" "potterybarnkids_en_pk_prd_d2" "westelm_qa_en_we_uat_d1" "bananarepublicfactory" "staples_ca_3day_fr" "interflora_co_uk" "next_silver_uk" "staples_qa" "staples_ca_qa_fr" "staplesadvantage_qa10" "forever21_eu_nl" "bloomique_com" "forever21_uk_com" "westelm_en_uat_d1" "officedepot_poc" "interflora_ie_uat1" "pbteen_en_pt_prd_release_test" "bananarepublic_gap_eu" "forever21_ca_fr" "westelm_qa_en_d2" "pbteen_qa_en_d1" "mattel" "disney" "gap_factory" "rb_auction" "mattel_dev" "markandgraham_qa_en_d1" "potterybarn_en_pb_prd_d1" "paperchase_co_uk" "staples_ca_fr" "potterybarn_qa_en_d2" "usabluebook" "sportsmansguide_qa" "gapcanada_ca" "forever21_es" "potterybarn_en_en_uat3_d1" "forever21_eu_es" "interflora_ie_uat2" "potterybarnkids_en_pk_uat3_d1" "staples_3day" "bananarepublic_uk" "forever21_eu_it" "pbteen_en_pt_prd_d3" "potterybarnkids_qa" "belk" "forever21_us_com" "westelm_en_uat2_d1" "potterybarn_en_pb_prd_d2" "mattel_qa" "interflora_co_uk_uat2" "albertsons_internal" "pbteen_en_pt_uat2_d1" "pbteen_en_pt_uat3_d1" "markandgraham_en_mg_prd_d1" "markandgraham_en_mg_prd_d2" "markandgraham_en_mg_prd_d3" "markandgraham_en_prd_release_test" "markandgraham_en_uat_d1" "markandgraham_en_uat2_d1" "markandgraham_en_uat3_d1" "williamssonoma_en_ws_prd_d2" "williamssonoma_en_ws_prd_d3" "williamssonoma_en_prd_release_test" "williamssonoma_en_uat_d1" "williamssonoma_en_uat2_d1" "williamssonoma_en_uat3_d1" "potterybarnkids_en_pk_uat_d1" "pbteen_qa_en_d2" "pbteen_qa_en_d3" "potterybarnkids_qa_en_d2" "potterybarnkids_qa_en_d3" "williamssonoma_qa_en_d3" "markandgraham_qa_en_d2" "markandgraham_qa_en_d3" "boden_global_fr" "advanceautoparts" "boden_global_de" "boden_uk" "jordans" "yliving" "jordans_pim" "puma_na" "harborfreight" "castorama" "pactronics" "castorama_pl" "travisperkins_co_uk" "poc_cloudcraze" "next_stage5" "castorama_pl_pl" "staplesadvantage_com" "forever21_mexico" "familydollar" "staples_com" "forever21_gl" "smartwool" "filson" "virginexperiencedays_co_uk" "rejuvenation" "elastic_path" "davidyurman" "next_bronze_2_en_ie" "next_intg1_stage2" "next_stage3" "next_stage4" "next_stage6" "next_bronze_2" "next_bronze_2_en" "next_intg1_stage3" "next_stage1" "next_intg1_stage1" "home24_de" "next_stage2" "halfords_livestage" "bands_group" "br_test" "br_test_fr" "marksandspencer" "demo_cloudcraze" "marks" "test_ablett" "shoes_test" "puma_eu" "directsupply" "eddiebauer_us_ca" "eddiebauer_us_ca_en_ca" "marks_fr" "boden_global_staging" "boden_global_staging_fr" "boden_global_staging_de" "albertsons_dev" "albertsons_qa" "puma_ca_seo" "partssource" "jordans" "hobbycraft" "robert_dyas" "onesourcedist" "demo_victoriassecret" "vip_next_uk" "bands_group_nl" "brsmtraining" "demo2_elasticpath" "pactronics_v3" "puma_eu_de" "puma_eu_fr" "robh_test" "pacific_v3" "demo_medline" "internal_feed_test" "demo_bigcommerce" "castorama_fr" "castorama_fr_fr" "bloomreach_devdocs" "hmv" "next_intg1_stage5" "next_intg1_stage4" "davidyurman_fr" "demo_taistech" "lequipeur" "seraphine" "seraphine_fr" "seraphine_de" "seraphine_es" "pokemon" "grabagun" "wickes_co_uk" "demo1_bloomreach" "davidyurman" "marks_en_lequipeur_en" "aux_zoro_co_uk" "littlelabel" "marketplace_albertsons" "zoro_us" "deltafaucet" "pricesmart" "tinyprints" "next_uk_bronze_en_clearance" "shutterfly_qa" "tinyprints_qa" "shutterfly_qa_en_d2" "tinyprints_qa_en_d2" "demo2_bloomreach" "robh_test_en_test1" "boden_usa" "boden_australia" "boden_eu" "pactronics" "internal_partner" "sportchek" "atmosphere" "nbrown" "demo_mscdirect" "bloomique_en" "ryman" "demo_sonepar_lumen" "bands_group_de" "bensons_for_beds" "vip_next_uk_en" "vip_next_uk_en" "vip_next_uk_en_sale" "harveys_furniture" "vip_next_uk_en_clearance" "dermstore" "freshdirect" "freshdirectattheoffice" "foodkick" "demo_turtle" "thenorthface_brsm" "staplesadvantage_qa7" "thenorthface_brseo_ca" "robh_test_en_test2" "robh_test_en" "bloomique_bg" "bloomique_hr" "bloomique_sk" "hillcity" "gapcanada_ca_fr" "Beresa" "test_content_search_eu" "test_content_search_us" "poc_cjk_en" "poc_cjk" "poc_chinese" "victoriassecret" "marksandspencer_stage1" "castorama_fr_fr_afa" "castorama_fr_fr_proof1" "castorama_fr_fr_proof5" "castorama_fr_fr_proof4" "castorama_fr_fr_proof3" "castorama_fr_fr_proof2" "boden_global_test" "zoro_co_uk" "nexla_us" "beresa_de" "demo_crateandbarrel" "boden_global_dev" "medline" "medline_athome" "poc_cjk_zh_poc_chinese_zh" "nbrown_stage2" "nbrown_stage1" "nbrown_stage1_en_cgn" "beresa_de_de" "nbrown_en_cgn" "nbrown_en_dal" "nbrown_en_jdw" "nbrown_en_awl" "poc_jap_en" "poc_chinese_ja_jap" "pricesmart_es" "poc_chn1_zh" "poc_chn1" "everythingbutwater" "speedway" "demo3_bloomreach" "littlelabel_stage1" "littlelabel_stage2" "bananarepublic_ca_fr" "littlelabel_stage3" "demo4_bloomreach" "brx_b2c_bloomreach" "biotechne" "medline_en" "medline_en" "medline" "thenorthface_co_uk" "puma_india" "reallygoodstuff" "thenorthface_co_uk_fr" "thenorthface_co_uk_de" "repco" "thenorthface_co_uk_it" "thenorthface_co_uk_es" "thenorthface_co_uk_nl" "napapijri_co_uk" "thenorthface_co_uk_pt" "thenorthface_co_uk_pl" "thenorthface_co_uk_da" "napapijri_co_uk_fr" "thenorthface_co_uk_cz" "napapijri_co_uk_it" "thenorthface_co_uk_sv" "demo5_bloomreach" "canadiantire" "thenorthface_brsm_fr" "repco_en__nz" "nancysnotions" "taconyonline" "powrflite" "kirklands" "pacific_fashion" "petsathome" "samsclub_qa" "goodmandealers" "thenorthface" "haworth" "brxmultitest_eng_onehippo_io" "brxsingletest_eng_onehippo_io" "brqa_automation" "gardencentre" "castorama_fr_fr_proof6" "wendoverart" "demo_tractorsupply" "repco_test" "repco_test_en_staged" "repco_en_nz" "repco_en_staged" "repco_en_nz_staged" "repco_test_en_nz" "repco_test_en_nz_staged" "canadiantire_fr" "goodmandealers_es" "demo_borngroup" "jegs_en_fitment" "nbrown_stage1_en_awl" "nbrown_stage2_en_cgn" "nbrown_stage1_en_dal" "nbrown_stage1_en_jdw" "nbrown_stage2_en_jdw" "nbrown_stage2_en_dal" "nbrown_stage2_en_awl" "demo_michaels" "goodmandealers_fr" "totalwine" "peirce" "digital_nhs_uk" "jegs_fitment" "pacific_supply" "thegrommet" "ariat" "ariat_eu" "haworth_es" "tradepoint" "haworth_fr" "haworth_de" "demo_tommyjohn" "pacifichome" "jegs" "speedwaymotors_brsm" "pacifichome_ct" "pacifichome_ep" "pacifichome_bc" "haworth_en_surface" "pacifichome_si" "pacifichome_sap" "nbrown_en_der" "nbrown_stage1_en_der" "adorama" "leisureproscuba" "supplyhouse" "sunnysports" "nbrown_stage2_en_der" "demo_mastek" "tradepoint_en_afa" "pacifichome_de" "petsathome_stage1" "next_global" "haworth_zh" "petsathome_stage2" "boden_global_test_de" "boden_global_test_fr" "boden_global_dev_fr" "boden_global_dev_de" "neimanmarcus_en" "demo8_bloomreach" "neimanmarcus_categories" "brxsaas_eng01" "brxsaas_eng02" "demo2_mscdirect" "testpanel_fei_brxsaas" "testpanel_kenan_brxsaas" "testpanel_mike_brxsaas" "testpanel_nuno_brxsaas" "test_br_eng" "test_br_eng_en_d1" "test_br_eng_en_d2" "haworth_ja" "tractorsupply" "bloomique_ja" "childsplayclothing_co_uk" "turtle" "pacific_supply_sfcc_dev" "tractorsupply_qa" "littlelabel_stage1_en_disc" "adorama_en_disc" "tractorsupply_qa_en__test" "adorama_en_rent" "leisurepro" "dedicated_shopify_dev" "dedicated_sap_dev" "nbrown_en_sbi" "nbrown_stage1_en_sbi" "timberland" "eaglecreek" "altrarunning" "nbrown_en_oxi" "nbrown_en_fw" "pfswebhybris" "test_suvojit" "test_suvojit_fr" "test_suvojit_de" "testpanel_aj_brxsaas" "tradepoint_en_proof2" "tradepoint_en_proof1" "staples_en" "tradepoint_en_proof3" "tradepoint_en_proof4" "tradepoint_en_proof5" "tradepoint_en_proof6" "travismathew" "pacific_supply_si" "bergdorfgoodman_categories" "diy_com_en_afa" "diy_com_en_proof1" "diy_com_en_proof2" "diy_com_en_proof3" "diy_com_en_proof4" "diy_com_en_proof5" "diy_com_en_proof6" "test_akashr" "celebrationfantastic" "gale" "grandvision_preview_brxsaas" "demo_anixter" "authentic_preview_brxsaas" "mohawk_pergo_na" "diva_e_preview_brxsaas" "saintgobain" "nbrown_stage1_en_oxi" "demo_officedepot" "demo_hilti" "demo2_sonepar" "nbrown_stage1_en_fw" "nbrown_stage2_en_oxi" "nbrown_stage2_en_sbi" "nbrown_stage2_en_fw" "seraphine_it" "demo2_sonepar_fr" "tedbaker" "demo2_sonepar_nl" "demo_cvs" "canadiantire_odp" "canadiantire_odp_fr" "demo_hilti_fr" "shindigz_brx" "demo_waeg" "harrods" "demo_melectronics_fr" "demo_melectronics_de" "demo_melectronics" "placemakers_tradeportal_co_nz" "placemakers_shop_co_nz" "partycity_ca" "qa_ph_automation" "ps_qa_automation" "dickies" "sunnysports_en_sunnysports_en_disc" "mscdirect_en_dc" "castorama_pl_pl_afa" "castorama_pl_pl_proof1" "castorama_pl_pl_proof2" "castorama_pl_pl_proof3" "castorama_pl_pl_proof4" "castorama_pl_pl_proof5" "castorama_pl_pl_proof6" "nbrown_en_ccl" "pacific_supply_mindcurv" "gorilla_preview_brxsaas" "otranorge_no" "sonepar_it" "cged_fr" "cebeo_be" "timberland_fr" "mindcurv_preview_brxsaas" "demo_raleys" "pacific_devtrial" "seven_for_all_mankind" "splendid" "poolcorp" "us_demo1_brxsaas" "officedepot" "test_us_feed" "test_us_feed_domains_views_en" "test_us_feed_domains_views_en_qa1" "tilemountain" "test_us_feed_domains_views_en_qa2" "test_us_feed_views" "test_us_feed_domains_views_en_qa3" "test_us_feed_domains_views" "vons" "globalindustrial" "developers_brxsaas" "napaonline_es_es" "mscdirect_fr" "sandbox_publicis" "mscdirect_en" "born_preview_brxsaas" "zoro" "shift7_preview_brxsaas" "kinandcarta_preview_brxsaas" "soneparcanada" "vans_canada" "tilemountain_en_ranges" "test_us_feed_domains_en_qa1" "test_us_feed_domains_zh_qa1" "test_us_feed_domains" "test_akashr_en_d1" "napaonline_en" "soneparcanada_en_dixonelectric" "soneparcanada_en_gescan" "albertsons_perf" "soneparcanada_es_gescanautomation" "soneparcanada_en" "soneparcanada_en_vallen" "soneparcanada_en_texcan" "soneparcanada_en_sesco" "soneparcanada_en_lumen" "soneparcanada_en_mgmelectric" "soneparcanada_en_gescanautomation" "napaonline_en_cpb" "nbrown_en_fsp" "nbrown_en_pma" "victoriassecret_global" "bluestem" "cebeo_be_fr" "sandbox_accenture" "cebeo_be_nl" "sandbox_perficient" "qa_ph_uk_automation" "ps_uk_qa_automation" "sonepar_it_it" "cged_fr_fr" "otranorge_no_no" "bluestem_en_fingerhut" "bluestem_en_gettington" "bluestem_en_haband" "bluestem_en_appleseeds" "bluestem_en_drapers" "bluestem_en_blair" "napapijri_co_uk_de" "napapijri_co_uk_es" "shindigz_brx_en_cat_meta" "sandbox_bornconnector" "napapijri_co_uk_nl" "napaonline_es_cpb" "popshelf" "napaonline_fr" "napaonline_es" "napaonline" "pacific_supply_global" "pacific_supply_global_de" "napacanada_en_cpb" "napacanada_fr_cpb" "tedbaker_fr" "tedbaker_de" "tedbaker_es" "mscdirect" "vans_canada_fr" "officedepot_bsd" "bloomfast" "demo2_victoriassecret" "raleys" "napacanada" "napacanada_fr" "diy_com_en_ie" "diy_com_en_ie_afa" "diy_com_en_ie_proof2" "ciaccarrierenterprise" "prcarrierenterprise" "totaline_com_mx" "carrierb2b" "pvh_b2b" "profserv01_brxsaas" "levelninesports" "toolstation" "profserv02_brxsaas" "davidsbridal_brx" "vuestorefront_brxsaas" "whitecap" "fullbeauty")
TARGET_REALM="release-perf-mob1"
SOURCE_REALM="release-perf-prod"
CLUSTER_NAME="qaparitytestAug25solr"

arr=()
for merchant in ${MERCHANTS[@]}; do
  sleep 1
  echo "-------------------------------------"
  echo ${merchant}
  (m=${merchant}; mob1lb=${MOB1_LB}; prodlb=${PROD_LB}; echo "----MOB1----"; curl -s "http://${mob1lb}/solr/${m}_products/select_anchor?q=*&wt=json&rows=0" | jq '.response.numFound'; echo "----PROD----"; curl -s "http://${prodlb}/solr/${m}_products/select_anchor?q=*&wt=json&rows=0" | jq '.response.numFound';)
  mob1_numFound=$(m=${merchant}; mob1lb=${MOB1_LB}; curl -s "http://${mob1lb}/solr/${m}_products/select_anchor?q=*&wt=json&rows=0" | jq '.response.numFound';)
  prod_numFound=$(m=${merchant}; prodlb=${PROD_LB}; curl -s "http://${prodlb}/solr/${m}_products/select_anchor?q=*&wt=json&rows=0" | jq '.response.numFound';)
  if [[ ${mob1_numFound} != ${prod_numFound} ]]; then
    echo "########## Num found mismatch for ${merchant} ##########"
    if [[ ${prod_numFound} > ${mob1_numFound} ]]; then
      echo "Copying Index from '" ${SOURCE_REALM} "' to '" ${TARGET_REALM} "'"
      curl -v POST "http://arka.bstore.bloomreach.com/api/solr/cluster/collection/replicateIndexFromMaster" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"data\": { \"cluster\": { \"app\": \"snap\", \"realm\": \"${TARGET_REALM}\", \"region\": \"us-east-1\", \"family\": \"default\", \"name\": \"${CLUSTER_NAME}\" }, \"master\": { \"app\": \"snap\", \"realm\": \"${SOURCE_REALM}\", \"region\": \"us-east-1\", \"family\": \"default\", \"name\": \"${CLUSTER_NAME}\" }, \"collection\": { \"siteDomainKey\": \"${merchant}\", \"dataType\": \"products\" } }}"
    elif [[ ${mob1_numFound} > ${prod_numFound} ]]; then
      curl -v POST "http://arka.bstore.bloomreach.com/api/solr/cluster/collection/replicateIndexFromMaster" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"data\": { \"cluster\": { \"app\": \"snap\", \"realm\": \"${SOURCE_REALM}\", \"region\": \"us-east-1\", \"family\": \"default\", \"name\": \"${CLUSTER_NAME}\" }, \"master\": { \"app\": \"snap\", \"realm\": \"${TARGET_REALM}\", \"region\": \"us-east-1\", \"family\": \"default\", \"name\": \"${CLUSTER_NAME}\" }, \"collection\": { \"siteDomainKey\": \"${merchant}\", \"dataType\": \"products\" } }}"
      echo "Copying Index from '" ${TARGET_REALM} "' to '" ${SOURCE_REALM} "'"
    fi
    arr+=(${merchant})
  fi
done
echo "Mismatched merchants"
echo ${arr[@]}


